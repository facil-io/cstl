## CLI (Command Line Interface)

```c
#define FIO_CLI
#include "fio-stl.h"
```

The facil.io library includes a CLI parser that provides a simpler API and more features than the array iteration based `getopt`, such as:

* Auto-generation of the "help" / usage output.

* Argument type testing (String, Boolean, and Integer types are supported).

* Global Hash map storage and access to the parsed argument values (until `fio_cli_end` is called).

* Support for unnamed options / arguments, including adjustable limits on how many a user may input.

* Array style support and access to unnamed arguments.

By defining `FIO_CLI`, the following functions will be defined.

In addition, `FIO_CLI` automatically includes the `FIO_ATOL`, `FIO_RAND` and `FIO_IMAP` flags, since CLI parsing and cleanup depends on them.

**Note**: the `fio_cli` module is **NOT** thread-safe unless limited to reading once multi-threading has started (reading is immutable, writing is where things can go wrong).

-------------------------------------------------------------------------------

### Types

#### `fio_cli_arg_e`

```c
typedef enum {
  FIO_CLI_ARG_STRING,       /* A String CLI argument */
  FIO_CLI_ARG_BOOL,         /* A Boolean CLI argument */
  FIO_CLI_ARG_INT,          /* An integer CLI argument */
  FIO_CLI_ARG_PRINT,        /* Print text with offset */
  FIO_CLI_ARG_PRINT_LINE,   /* Print text as-is */
  FIO_CLI_ARG_PRINT_HEADER, /* Print text as header */
} fio_cli_arg_e;

#define FIO_CLI_ARG_NONE FIO_CLI_ARG_PRINT_HEADER
```

An enumeration of CLI argument types used internally and returned by `fio_cli_type`.

**Values:**
- `FIO_CLI_ARG_STRING` - A string argument that accepts any value
- `FIO_CLI_ARG_BOOL` - A boolean flag (no value accepted)
- `FIO_CLI_ARG_INT` - An integer argument (validated during parsing)
- `FIO_CLI_ARG_PRINT` - Used for printing help text with offset
- `FIO_CLI_ARG_PRINT_LINE` - Used for printing help text as-is
- `FIO_CLI_ARG_PRINT_HEADER` - Used for printing section headers in help
- `FIO_CLI_ARG_NONE` - Alias for `FIO_CLI_ARG_PRINT_HEADER`

-------------------------------------------------------------------------------

### Argument Definition Macros

These macros are used within `fio_cli_start` to define command line arguments and help text formatting.

#### `FIO_CLI_STRING`

```c
#define FIO_CLI_STRING(line) /* ... */
```

Indicates the CLI argument should be a String (default type).

Example:

```c
FIO_CLI_STRING("-o -output (stdout) output file path")
```

#### `FIO_CLI_INT`

```c
#define FIO_CLI_INT(line) /* ... */
```

Indicates the CLI argument should be an Integer (numerical). The parser validates that the provided value is a valid integer.

Example:

```c
FIO_CLI_INT("-p -port (8080) the port number to use")
```

#### `FIO_CLI_BOOL`

```c
#define FIO_CLI_BOOL(line) /* ... */
```

Indicates the CLI argument is a Boolean value (flag). Boolean arguments cannot have default values and do not accept values - their presence indicates `true`.

Example:

```c
FIO_CLI_BOOL("-v -verbose enable verbose logging")
```

**Note**: Boolean flags can be chained, e.g., `-abc` is equivalent to `-a -b -c`.

#### `FIO_CLI_PRINT`

```c
#define FIO_CLI_PRINT(line) /* ... */
```

Indicates the CLI string should be printed as-is with proper offset (indentation). Used to add extra information related to the previous argument.

Example:

```c
FIO_CLI_INT("-p -port (8080) the port number"),
FIO_CLI_PRINT("Set to 0 for Unix socket mode.")
```

#### `FIO_CLI_PRINT_LINE`

```c
#define FIO_CLI_PRINT_LINE(line) /* ... */
```

Indicates the CLI string should be printed as-is with no offset. Used for raw text output in help.

Example:

```c
FIO_CLI_PRINT_LINE("Visit https://example.com for more information.")
```

#### `FIO_CLI_PRINT_HEADER`

```c
#define FIO_CLI_PRINT_HEADER(line) /* ... */
```

Indicates the CLI string should be printed as a section header (with underline formatting).

Example:

```c
FIO_CLI_PRINT_HEADER("Network Options:")
```

-------------------------------------------------------------------------------

### Initialization and Cleanup

#### `fio_cli_start`

```c
#define fio_cli_start(argc, argv, unnamed_min, unnamed_max, description, ...)  \
  fio_cli_start((argc),                                                        \
                (argv),                                                        \
                (unnamed_min),                                                 \
                (unnamed_max),                                                 \
                (description),                                                 \
                (fio___cli_line_s[]){__VA_ARGS__, {0}})

/* The shadowed function: */
void fio_cli_start(int argc,
                   char const *argv[],
                   int unnamed_min,
                   int unnamed_max,
                   char const *description,
                   fio___cli_line_s *arguments);
```

The `fio_cli_start` **macro** shadows the `fio_cli_start` function and defines the CLI interface to be parsed.

The macro accepts:
- `argc` - command line argument count (from `main`)
- `argv` - command line argument list (from `main`)
- `unnamed_min` - the required minimum of unnamed arguments
- `unnamed_max` - the maximum limit of unnamed arguments (use `-1` for unlimited)
- `description` - a C string containing the program's description
- `...` - a variable list of argument definitions using the `FIO_CLI_*` macros

If `unnamed_min` is set to `-1`, there will be no limit on the number of unnamed/unrecognized arguments allowed.

The text `NAME` in the description (all capitals) will be replaced with the executable command invoking the application.

Argument names **must** start with the `-` character. The first word starting without the `-` character will begin the description for the CLI argument.

The arguments `-?`, `-h`, `-help` and `--help` are automatically handled unless overridden.

**Note**: default values may optionally be provided by placing them in parenthesis immediately after the argument name and aliases. Default values that start with `(` must end with `)` (the surrounding parenthesis are ignored). Default values that start with `("` must end with `")` (the surrounding start and end markers are ignored).

**Note**: this function is **NOT** thread-safe.

Example:

```c
#define FIO_CLI
#include "fio-stl.h"

int main(int argc, char const *argv[]) {
  fio_cli_start(argc, argv, 0, -1,
                "This is a CLI example for the NAME application.\n"
                "This example allows for unlimited arguments that will be printed.",
                FIO_CLI_PRINT_HEADER("CLI type validation"),
                FIO_CLI_STRING("-s -str (my default string) any string data"),
                FIO_CLI_INT("-i -int (42) integer data"),
                FIO_CLI_BOOL("-b -bool flag (boolean) only - no data"),
                FIO_CLI_PRINT("Boolean flags cannot have default values."),
                FIO_CLI_PRINT_LINE("We hope you enjoy the NAME example.")
                );

  if (fio_cli_get("-s")) /* always true when default value is provided */
    fprintf(stderr, "String: %s\n", fio_cli_get("-s"));

  fprintf(stderr, "Integer: %d\n", (int)fio_cli_get_i("-i"));
  fprintf(stderr, "Boolean: %d\n", (int)fio_cli_get_i("-b"));

  if (fio_cli_unnamed_count()) {
    fprintf(stderr, "Printing unlisted / unrecognized arguments:\n");
    for (size_t i = 0; i < fio_cli_unnamed_count(); ++i) {
      fprintf(stderr, "%s\n", fio_cli_unnamed(i));
    }
  }

  fio_cli_end();
  return 0;
}
```

Arguments can be provided in multiple formats:

```
app -t=1 -p3000 -a localhost
app -t 1 -p 3000 -a localhost
app --threads=1 --port=3000 --address=localhost
```

#### `fio_cli_end`

```c
void fio_cli_end(void);
```

Clears the CLI data storage and frees all memory used by the CLI parser.

**Note**: this function has a destructor attribute and will be called automatically at program exit. However, calling it explicitly allows memory to be freed earlier.

**Note**: this function is **NOT** thread-safe.

-------------------------------------------------------------------------------

### Getting Argument Values

#### `fio_cli_get`

```c
char const *fio_cli_get(char const *name);
```

Returns the argument's value as a NUL-terminated C string, or `NULL` if the argument wasn't provided.

If `name` is `NULL`, returns the first unnamed argument (equivalent to `fio_cli_unnamed(0)`).

#### `fio_cli_get_str`

```c
fio_buf_info_s fio_cli_get_str(char const *name);
```

Returns the argument's value as a `fio_buf_info_s` structure containing both the string pointer and its length.

If `name` is `NULL`, returns the first unnamed argument.

Returns an empty `fio_buf_info_s` (with `NULL` buffer) if the argument wasn't provided.

#### `fio_cli_get_i`

```c
int64_t fio_cli_get_i(char const *name);
```

Returns the argument's value as an integer, or `0` if the argument wasn't provided.

**Note**: the command-line accepts integers in base 10, base 16, base 8 and binary as long as they have the appropriate prefix (i.e., none, `0x`, `0`, `0b`).

#### `fio_cli_get_bool`

```c
#define fio_cli_get_bool(name) (fio_cli_get((name)) != NULL)
```

Evaluates to `true` (non-zero) if the argument was provided. Otherwise evaluates to `false` (0).

This is typically used for boolean flags but works with any argument type.

#### `fio_cli_type`

```c
fio_cli_arg_e fio_cli_type(char const *name);
```

Returns the argument's expected content type as defined during `fio_cli_start`.

Returns `FIO_CLI_ARG_NONE` if the argument name is not recognized.

-------------------------------------------------------------------------------

### Unnamed Arguments

#### `fio_cli_unnamed_count`

```c
unsigned int fio_cli_unnamed_count(void);
```

Returns the number of unnamed arguments (arguments not matching any defined argument names).

#### `fio_cli_unnamed`

```c
char const *fio_cli_unnamed(unsigned int index);
```

Returns a NUL-terminated C string containing the unnamed argument at the stated `index` (indexes are zero-based).

Returns `NULL` if `index` is out of bounds.

#### `fio_cli_unnamed_str`

```c
fio_buf_info_s fio_cli_unnamed_str(unsigned int index);
```

Returns the unnamed argument at the stated `index` as a `fio_buf_info_s` structure containing both the string pointer and its length.

Returns an empty `fio_buf_info_s` if `index` is out of bounds.

-------------------------------------------------------------------------------

### Setting Argument Values

#### `fio_cli_set`

```c
void fio_cli_set(char const *name, char const *value);
```

Sets a value for the named argument. The value will propagate to all named aliases.

If `name` is `NULL`, adds `value` as a new unnamed argument.

**Note**: this function is **NOT** thread-safe.

#### `fio_cli_set_i`

```c
void fio_cli_set_i(char const *name, int64_t i);
```

Sets a numerical value for the named argument by converting it to a base-10 string representation.

**Note**: this function is **NOT** thread-safe.

#### `fio_cli_set_unnamed`

```c
unsigned int fio_cli_set_unnamed(unsigned int index, const char *value);
```

Sets or adds an unnamed argument at the specified `index` in the array of unnamed elements.

If `index` is greater than or equal to the current count of unnamed arguments, the value is appended to the end.

Returns the actual index where the value was stored, or `(unsigned int)-1` if `value` is `NULL` or empty.

**Note**: this function is **NOT** thread-safe.

-------------------------------------------------------------------------------

### Iteration

#### `fio_cli_each`

```c
size_t fio_cli_each(int (*task)(fio_buf_info_s name,
                                fio_buf_info_s value,
                                fio_cli_arg_e arg_type,
                                void *udata),
                    void *udata);
```

Calls `task` for every argument that was received (has a value), returning the number of times `task` was called.

If `task` returns a non-zero value, iteration stops early and `fio_cli_each` returns.

The `udata` pointer is an opaque user pointer passed to each invocation of `task`.

For unnamed arguments, `name` will have a `NULL` buffer and zero length.

-------------------------------------------------------------------------------
