## OTP

```c
#define FIO_OTP
#include FIO_INCLUDE_FILE
```

By defining the `FIO_OTP`, a small T-OTP (Time based One Time Password) helper API will be provided. This requires the `FIO_SHA1` and `FIO_STR` modules.

### OTP Settings

#### `fio_otp_settings_s`

```c
typedef struct {
  /** The time interval for TOTP rotation. */
  size_t interval; /* 30 == Google OTP */
  /** The number of digits in the OTP. */
  size_t digits; /* 6 == Google OTP */
  /** The time offset (in `interval` units) from the current time. */
  int64_t offset; /* 0 == Google OTP */
  /** Set to true if the secret / key is in Hex instead of Byte32 encoding. */
  uint8_t is_hex;
  /** Set to true if the secret / key is raw bit data (no encoding). */
  uint8_t is_raw;
} fio_otp_settings_s;
```

Settings structure for OTP generation.

**Members:**
- `interval` - The time interval for TOTP rotation (defaults to 30 seconds for Google OTP compatibility)
- `digits` - The number of digits in the OTP (defaults to 6 for Google OTP compatibility)
- `offset` - The time offset in `interval` units from the current time (defaults to 0 for current time)
- `is_hex` - Set to true if the secret/key is in Hex encoding instead of Base32 encoding
- `is_raw` - Set to true if the secret/key is raw bit data (no encoding)

### OTP API

#### `fio_otp_generate_key`

```c
fio_u128 fio_otp_generate_key(void);
```

Generates a cryptographically secure random 128 bit key for TOTP processing.

Uses system CSPRNG via `fio_rand_bytes_secure()`. Random keys may be required when generating a new OTP secret for possible logins.

**Returns:** A 128-bit random key suitable for TOTP secrets.

#### `fio_otp_print_key`

```c
size_t fio_otp_print_key(char *dest, uint8_t *key, size_t len);
```

Prints out an OTP secret (big endian number) as a Base32 encoded String.

Printing out the OTP secret can be important when providing it to authentication apps.

**Parameters:**
- `dest` - destination buffer for the Base32 encoded string
- `key` - pointer to the key bytes (if NULL, generates a new key)
- `len` - length of the key in bytes

**Returns:** The length of the encoded string written to `dest`.

#### `fio_otp`

```c
uint32_t fio_otp(fio_buf_info_s secret, fio_otp_settings_s settings);
/* Named arguments using macro. */
#define fio_otp(secret, ...) fio_otp(secret, (fio_otp_settings_s){__VA_ARGS__})
```

Returns a TOTP based on `secret` and the OTP settings using the current time.

This can be used to either validate an existing TOTP or generate a new one.

The function is shadowed by a macro, allowing it to accept named arguments:

```c
uint32_t totp_now = fio_otp(FIO_BUF_INFO1("My Secret"), .offset = 0);
uint32_t previous = fio_otp(FIO_BUF_INFO1("My Secret"), .offset = -1);
```

**Parameters:**
- `secret` - the shared secret key as a `fio_buf_info_s`

**Named Arguments:**

| Argument | Type | Description |
|----------|------|-------------|
| `interval` | `size_t` | Time interval for rotation; defaults to 30 |
| `digits` | `size_t` | Number of digits in OTP; defaults to 6 |
| `offset` | `int64_t` | Time offset in interval units; defaults to 0 |
| `is_hex` | `uint8_t` | Set true if secret is Hex encoded |
| `is_raw` | `uint8_t` | Set true if secret is raw bit data |

**Returns:** The computed TOTP value as a `uint32_t`.

#### `fio_otp_at`

```c
uint32_t fio_otp_at(fio_buf_info_s secret, uint64_t unix_time, fio_otp_settings_s settings);
/* Named arguments using macro. */
#define fio_otp_at(secret, unix_time, ...)                                     \
  fio_otp_at(secret, unix_time, (fio_otp_settings_s){__VA_ARGS__})
```

Returns a TOTP for a specific unix timestamp.

This is useful for verifying OTPs at specific times or for RFC test vectors.

The function is shadowed by a macro, allowing it to accept named arguments:

```c
/* Compute OTP at a specific timestamp */
uint32_t otp = fio_otp_at(FIO_BUF_INFO1("My Secret"), 1234567890);
```

**Parameters:**
- `secret` - the shared secret key as a `fio_buf_info_s`
- `unix_time` - the unix timestamp to compute the OTP for

**Named Arguments:**

| Argument | Type | Description |
|----------|------|-------------|
| `interval` | `size_t` | Time interval for rotation; defaults to 30 |
| `digits` | `size_t` | Number of digits in OTP; defaults to 6 |
| `offset` | `int64_t` | Time offset in interval units; defaults to 0 |
| `is_hex` | `uint8_t` | Set true if secret is Hex encoded |
| `is_raw` | `uint8_t` | Set true if secret is raw bit data |

**Returns:** The computed TOTP value as a `uint32_t`.

-------------------------------------------------------------------------------
