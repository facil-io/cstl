## ASN.1 DER Parser

```c
#define FIO_ASN1
#include FIO_INCLUDE_FILE
```

By defining `FIO_ASN1`, an ASN.1 DER (Distinguished Encoding Rules) parser is made available. This module provides parsing capabilities for X.509 certificates and other DER-encoded data structures commonly used in TLS and cryptographic applications.

The parser is non-allocating - all returned pointers reference the original DER data, which must remain valid while the parsed structures are in use.

### Types

#### `fio_asn1_tag_e`

```c
typedef enum {
  FIO_ASN1_EOC = 0x00,               /* End-of-contents */
  FIO_ASN1_BOOLEAN = 0x01,           /* Boolean */
  FIO_ASN1_INTEGER = 0x02,           /* Integer */
  FIO_ASN1_BIT_STRING = 0x03,        /* Bit String */
  FIO_ASN1_OCTET_STRING = 0x04,      /* Octet String */
  FIO_ASN1_NULL = 0x05,              /* Null */
  FIO_ASN1_OID = 0x06,               /* Object Identifier */
  FIO_ASN1_UTF8_STRING = 0x0C,       /* UTF-8 String */
  FIO_ASN1_SEQUENCE = 0x10,          /* Sequence (0x30 with constructed bit) */
  FIO_ASN1_SET = 0x11,               /* Set (0x31 with constructed bit) */
  FIO_ASN1_PRINTABLE_STRING = 0x13,  /* Printable String */
  FIO_ASN1_IA5_STRING = 0x16,        /* IA5 String (ASCII) */
  FIO_ASN1_UTC_TIME = 0x17,          /* UTC Time */
  FIO_ASN1_GENERALIZED_TIME = 0x18,  /* Generalized Time */
  FIO_ASN1_CONTEXT_0 = 0xA0,         /* [0] EXPLICIT/IMPLICIT */
  FIO_ASN1_CONTEXT_1 = 0xA1,         /* [1] EXPLICIT/IMPLICIT */
  FIO_ASN1_CONTEXT_2 = 0xA2,         /* [2] EXPLICIT/IMPLICIT */
  FIO_ASN1_CONTEXT_3 = 0xA3,         /* [3] EXPLICIT/IMPLICIT */
} fio_asn1_tag_e;
```

ASN.1 Universal Tag Types used to identify element types in DER-encoded data.

#### `fio_asn1_class_e`

```c
typedef enum {
  FIO_ASN1_CLASS_UNIVERSAL = 0,   /* Universal (built-in types) */
  FIO_ASN1_CLASS_APPLICATION = 1, /* Application-specific */
  FIO_ASN1_CLASS_CONTEXT = 2,     /* Context-specific */
  FIO_ASN1_CLASS_PRIVATE = 3,     /* Private */
} fio_asn1_class_e;
```

ASN.1 Tag Class values (bits 7-6 of the tag byte).

#### `fio_asn1_element_s`

```c
typedef struct {
  const uint8_t *data;    /* Pointer to element content (after tag+length) */
  size_t len;             /* Length of content */
  uint8_t tag;            /* Raw tag byte */
  uint8_t is_constructed; /* 1 if constructed (contains other elements) */
  uint8_t tag_class;      /* 0=Universal, 1=Application, 2=Context, 3=Private */
  uint8_t tag_number;     /* Tag number (bits 4-0, or extended) */
} fio_asn1_element_s;
```

Parsed ASN.1 DER element structure.

**Members:**
- `data` - pointer to the element's content bytes (after tag and length fields)
- `len` - length of the content in bytes
- `tag` - the raw tag byte as it appears in the DER encoding
- `is_constructed` - 1 if the element contains nested elements, 0 for primitive
- `tag_class` - the tag class (Universal, Application, Context, or Private)
- `tag_number` - the tag number within its class

#### `fio_asn1_iterator_s`

```c
typedef struct {
  const uint8_t *pos; /* Current position */
  const uint8_t *end; /* End of sequence */
} fio_asn1_iterator_s;
```

Iterator for traversing SEQUENCE or SET contents.

**Members:**
- `pos` - current position within the sequence
- `end` - pointer to the end of the sequence data

### OID Constants

The module defines commonly used OID string constants for X.509 and TLS:

```c
/* Signature Algorithms */
#define FIO_OID_SHA256_WITH_RSA   "1.2.840.113549.1.1.11"
#define FIO_OID_SHA384_WITH_RSA   "1.2.840.113549.1.1.12"
#define FIO_OID_SHA512_WITH_RSA   "1.2.840.113549.1.1.13"
#define FIO_OID_RSA_PSS           "1.2.840.113549.1.1.10"
#define FIO_OID_ECDSA_WITH_SHA256 "1.2.840.10045.4.3.2"
#define FIO_OID_ED25519           "1.3.101.112"

/* Public Key Algorithms */
#define FIO_OID_RSA_ENCRYPTION "1.2.840.113549.1.1.1"
#define FIO_OID_EC_PUBLIC_KEY  "1.2.840.10045.2.1"

/* Elliptic Curves */
#define FIO_OID_SECP256R1 "1.2.840.10045.3.1.7"
#define FIO_OID_SECP384R1 "1.3.132.0.34"
#define FIO_OID_X25519    "1.3.101.110"

/* X.509 Extensions */
#define FIO_OID_BASIC_CONSTRAINTS "2.5.29.19"
#define FIO_OID_KEY_USAGE         "2.5.29.15"
#define FIO_OID_SUBJECT_ALT_NAME  "2.5.29.17"

/* Distinguished Name Attributes */
#define FIO_OID_COMMON_NAME  "2.5.4.3"
#define FIO_OID_ORGANIZATION "2.5.4.10"
```

### Core Parser Functions

#### `fio_asn1_parse`

```c
const uint8_t *fio_asn1_parse(fio_asn1_element_s *elem,
                              const uint8_t *data,
                              size_t data_len);
```

Parses one ASN.1 element from DER-encoded data.

**Parameters:**
- `elem` - output structure to fill with parsed element info
- `data` - pointer to DER-encoded data
- `data_len` - length of data buffer

**Returns:** pointer to the next element (after this one), or NULL on error.

Example:

```c
fio_asn1_element_s elem;
const uint8_t *next = fio_asn1_parse(&elem, der_data, der_len);
if (next) {
  printf("Tag: 0x%02X, Length: %zu\n", elem.tag, elem.len);
}
```

#### `fio_asn1_element_total_len`

```c
size_t fio_asn1_element_total_len(const fio_asn1_element_s *elem,
                                  const uint8_t *data);
```

Gets the total encoded length of an ASN.1 element (tag + length + content).

**Parameters:**
- `elem` - parsed element
- `data` - original data pointer where element was parsed from

**Returns:** total bytes used by the element encoding.

### Type-Specific Parsers

#### `fio_asn1_parse_integer`

```c
int fio_asn1_parse_integer(const fio_asn1_element_s *elem, uint64_t *value);
```

Parses an ASN.1 INTEGER element.

For small integers (<= 64-bit), sets `*value`. For large integers (e.g., RSA modulus), use `elem->data` and `elem->len` directly. Leading zero bytes for positive numbers are handled correctly.

**Parameters:**
- `elem` - parsed element (must be INTEGER type)
- `value` - output for integer value (can be NULL for large integers)

**Returns:** 0 on success, -1 on error.

#### `fio_asn1_parse_bit_string`

```c
int fio_asn1_parse_bit_string(const fio_asn1_element_s *elem,
                              const uint8_t **bits,
                              size_t *bit_len,
                              uint8_t *unused_bits);
```

Parses an ASN.1 BIT STRING element.

**Parameters:**
- `elem` - parsed element (must be BIT STRING type)
- `bits` - output pointer to bit data
- `bit_len` - output length of bit data in bytes
- `unused_bits` - output number of unused bits in last byte (0-7)

**Returns:** 0 on success, -1 on error.

#### `fio_asn1_parse_oid`

```c
int fio_asn1_parse_oid(const fio_asn1_element_s *elem,
                       char *buf,
                       size_t buf_len);
```

Parses an ASN.1 OID into a dot-separated string.

**Parameters:**
- `elem` - parsed element (must be OID type)
- `buf` - output buffer for string
- `buf_len` - buffer size

**Returns:** number of characters written (excluding NUL), or -1 on error.

Example:

```c
char oid_str[128];
int len = fio_asn1_parse_oid(&elem, oid_str, sizeof(oid_str));
if (len > 0) {
  printf("OID: %s\n", oid_str);  /* e.g., "1.2.840.113549.1.1.11" */
}
```

#### `fio_asn1_oid_eq`

```c
int fio_asn1_oid_eq(const fio_asn1_element_s *elem, const char *oid_string);
```

Compares an ASN.1 OID element to a known OID string.

**Parameters:**
- `elem` - parsed element (must be OID type)
- `oid_string` - OID in dot notation (e.g., "1.2.840.113549.1.1.11")

**Returns:** 1 if match, 0 if no match.

Example:

```c
if (fio_asn1_oid_eq(&elem, FIO_OID_SHA256_WITH_RSA)) {
  printf("Signature algorithm: SHA-256 with RSA\n");
}
```

#### `fio_asn1_parse_time`

```c
int fio_asn1_parse_time(const fio_asn1_element_s *elem, int64_t *unix_time);
```

Parses an ASN.1 time (UTC Time or Generalized Time) to Unix timestamp.

**Parameters:**
- `elem` - parsed element (must be UTC_TIME or GENERALIZED_TIME type)
- `unix_time` - output Unix timestamp (seconds since 1970-01-01 00:00:00 UTC)

**Returns:** 0 on success, -1 on error.

#### `fio_asn1_parse_string`

```c
const char *fio_asn1_parse_string(const fio_asn1_element_s *elem, size_t *len);
```

Parses an ASN.1 string element.

Supports UTF8String, PrintableString, IA5String, and other string types. Returns a pointer directly into the element data (no copy).

**Parameters:**
- `elem` - parsed element (must be a string type)
- `len` - output length of string

**Returns:** pointer to string data, or NULL on error.

#### `fio_asn1_parse_boolean`

```c
int fio_asn1_parse_boolean(const fio_asn1_element_s *elem, int *value);
```

Parses an ASN.1 BOOLEAN element.

**Parameters:**
- `elem` - parsed element (must be BOOLEAN type)
- `value` - output boolean value (0 = false, non-zero = true)

**Returns:** 0 on success, -1 on error.

### Sequence/Set Iteration

#### `fio_asn1_iterator_init`

```c
void fio_asn1_iterator_init(fio_asn1_iterator_s *it,
                            const fio_asn1_element_s *sequence);
```

Initializes an iterator for a SEQUENCE or SET element.

**Parameters:**
- `it` - iterator to initialize
- `sequence` - parsed element (must be SEQUENCE or SET)

#### `fio_asn1_iterator_next`

```c
int fio_asn1_iterator_next(fio_asn1_iterator_s *it, fio_asn1_element_s *elem);
```

Gets the next element from an iterator.

**Parameters:**
- `it` - iterator (updated to point to next element)
- `elem` - output for parsed element

**Returns:** 0 if element available, -1 if end or error.

#### `fio_asn1_iterator_has_next`

```c
int fio_asn1_iterator_has_next(const fio_asn1_iterator_s *it);
```

Checks if iterator has more elements.

**Parameters:**
- `it` - iterator

**Returns:** 1 if more elements available, 0 otherwise.

Example:

```c
fio_asn1_iterator_s it;
fio_asn1_element_s child;

fio_asn1_iterator_init(&it, &sequence_elem);
while (fio_asn1_iterator_next(&it, &child) == 0) {
  printf("Child tag: 0x%02X\n", child.tag);
}
```

### Helper Functions

#### `fio_asn1_is_tag`

```c
int fio_asn1_is_tag(const fio_asn1_element_s *elem, uint8_t tag);
```

Checks if an element is a specific tag type.

**Parameters:**
- `elem` - parsed element
- `tag` - expected tag (e.g., `FIO_ASN1_INTEGER`)

**Returns:** 1 if match, 0 otherwise.

#### `fio_asn1_is_context_tag`

```c
int fio_asn1_is_context_tag(const fio_asn1_element_s *elem, uint8_t tag_num);
```

Checks if an element is a context-specific tag.

**Parameters:**
- `elem` - parsed element
- `tag_num` - context tag number (0-31)

**Returns:** 1 if match, 0 otherwise.

Example:

```c
/* Check for X.509 version field [0] */
if (fio_asn1_is_context_tag(&elem, 0)) {
  /* Parse version number */
}
```

#### `fio_asn1_tag_number`

```c
uint8_t fio_asn1_tag_number(const fio_asn1_element_s *elem);
```

Gets the tag number from an element.

For universal tags, returns the tag value (0-30). For context-specific tags, returns the context number.

**Parameters:**
- `elem` - parsed element

**Returns:** tag number.

### Example: Parsing an X.509 Certificate

```c
#define FIO_ASN1
#include "fio-stl/include.h"

void parse_certificate(const uint8_t *der, size_t der_len) {
  fio_asn1_element_s cert_seq;
  
  /* Parse outer SEQUENCE */
  if (!fio_asn1_parse(&cert_seq, der, der_len)) {
    printf("Failed to parse certificate\n");
    return;
  }
  
  if (!fio_asn1_is_tag(&cert_seq, FIO_ASN1_SEQUENCE)) {
    printf("Not a valid certificate\n");
    return;
  }
  
  /* Iterate through certificate fields */
  fio_asn1_iterator_s it;
  fio_asn1_element_s tbs, sig_alg, sig_value;
  
  fio_asn1_iterator_init(&it, &cert_seq);
  
  /* TBSCertificate */
  if (fio_asn1_iterator_next(&it, &tbs) != 0) return;
  
  /* SignatureAlgorithm */
  if (fio_asn1_iterator_next(&it, &sig_alg) != 0) return;
  
  /* SignatureValue */
  if (fio_asn1_iterator_next(&it, &sig_value) != 0) return;
  
  printf("Certificate parsed successfully\n");
  printf("TBS length: %zu bytes\n", tbs.len);
}
```

------------------------------------------------------------
